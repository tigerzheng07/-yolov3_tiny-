import os

# ========== ä¸‹è½½YOLOv3-tinyæ¨¡å‹æ–‡ä»¶ ==========
yolov3_tiny_dir = "/content/yolov3-tiny"
if not os.path.exists(yolov3_tiny_dir):
    os.makedirs(yolov3_tiny_dir)  # åˆ›å»ºç›®æ ‡ç›®å½•

# 1. ä¸‹è½½é…ç½®æ–‡ä»¶ï¼ˆ.cfgï¼‰
!wget https://raw.githubusercontent.com/pjreddie/darknet/master/cfg/yolov3-tiny.cfg \
    -O {yolov3_tiny_dir}/yolov3-tiny.cfg

# 2. ä¸‹è½½æƒé‡æ–‡ä»¶ï¼ˆ.weightsï¼‰
!wget https://pjreddie.com/media/files/yolov3-tiny.weights \
    -O {yolov3_tiny_dir}/yolov3-tiny.weights

# 3. ä¸‹è½½COCOç±»åˆ«åæ–‡ä»¶ï¼ˆ.namesï¼Œä¸YOLOv3å…±ç”¨ï¼‰
!wget https://raw.githubusercontent.com/pjreddie/darknet/master/data/coco.names \
    -O {yolov3_tiny_dir}/coco.names

print("\n=== YOLOv3-tiny ç›®å½•ä¸‹çš„æ–‡ä»¶ ===")
!ls {yolov3_tiny_dir}

!pip install opencv-python numpy pygame
!pip install ultralytics --quiet

import cv2
import numpy as np
import pygame
import json
import time
from datetime import datetime
from IPython.display import display, clear_output, Image
import ipywidgets as widgets
import threading
from io import BytesIO
import PIL.Image

# é¢œè‰²é…ç½®
COLORS = {
    'background': (30, 30, 50),
    'text': (255, 255, 255),
    'highlight': (255, 255, 0),
    'unlocked': (100, 255, 100),
    'locked': (100, 100, 100),
    'rarity1': (200, 200, 200),
    'rarity2': (100, 255, 100),
    'rarity3': (100, 100, 255)
}

# å¯æ”¶é›†ç‰©å“
COLLECTIBLES = {
    'keyboard': {'name': 'Keyboard', 'rarity': 2, 'desc': 'Input device'},
    'mouse': {'name': 'Mouse', 'rarity': 2, 'desc': 'Pointing device'},
    'laptop': {'name': 'Laptop', 'rarity': 3, 'desc': 'Portable computer'},
    'cell phone': {'name': 'Phone', 'rarity': 2, 'desc': 'Mobile device'},
    'book': {'name': 'Book', 'rarity': 1, 'desc': 'Reading material'}
}

import os
import time
import json
import threading
import cv2
import numpy as np
from datetime import datetime
from ultralytics import YOLO
from google.colab.patches import cv2_imshow

# ç¤ºä¾‹æ”¶è—ç‰©å“ï¼ˆä½ å¯è‡ªè¡Œå®šä¹‰ï¼‰
COLLECTIBLES = {
    "person": {"name": "äºº", "rarity": 1},
    "bicycle": {"name": "è‡ªè¡Œè½¦", "rarity": 2},
    "car": {"name": "æ±½è½¦", "rarity": 3}
}

# é¢œè‰²æ˜ å°„ï¼ˆrarityç­‰çº§é¢œè‰²ï¼‰
COLORS = {
    "rarity1": (0, 255, 0),
    "rarity2": (0, 165, 255),
    "rarity3": (0, 0, 255)
}

class ObjectCollector:
    def __init__(self):
        self.model = None
        self.classes = []
        self.cap = None
        self.collection = {}
        self.is_running = False
        self.current_frame = None
        self.load_collection()

    def load_yolo_tiny(self):
        """åŠ è½½YOLOv3-tinyæ¨¡å‹"""
        try:
            self.model = YOLO('yolov3-tiny.pt')  # è‡ªåŠ¨ä¸‹è½½æƒé‡
            self.classes = self.model.names  # è·å–ç±»åˆ«
            print("âœ… YOLOv3-tinyæ¨¡å‹åŠ è½½æˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ æ¨¡å‹åŠ è½½å¤±è´¥: {e}")
            return False

    def init_camera(self):
        """åˆå§‹åŒ–æ‘„åƒå¤´"""
        try:
            self.cap = cv2.VideoCapture(0)
            if not self.cap.isOpened():
                print("âŒ æ— æ³•æ‰“å¼€æ‘„åƒå¤´")
                return False
            print("âœ… æ‘„åƒå¤´åˆå§‹åŒ–æˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥: {e}")
            return False

    def load_collection(self):
        """åŠ è½½æ”¶é›†è®°å½•"""
        try:
            if os.path.exists('collection.json'):
                with open('collection.json', 'r') as f:
                    self.collection = json.load(f)
            else:
                for item in COLLECTIBLES:
                    self.collection[item] = {
                        'collected': False,
                        'count': 0,
                        'first_collected': None,
                        'last_collected': None
                    }
            print("âœ… æ”¶é›†è®°å½•åŠ è½½æˆåŠŸ")
        except Exception as e:
            print(f"âŒ æ”¶é›†è®°å½•åŠ è½½å¤±è´¥: {e}")

    def save_collection(self):
        """ä¿å­˜æ”¶é›†è®°å½•"""
        try:
            with open('collection.json', 'w') as f:
                json.dump(self.collection, f, indent=2)
        except Exception as e:
            print(f"âŒ ä¿å­˜å¤±è´¥: {e}")

    def detect_objects(self, frame, confidence_threshold=0.3):
        """æ£€æµ‹ç‰©ä½“"""
        if self.model is None:
            return frame, []

        results = self.model(frame, conf=confidence_threshold)
        result_frame = frame.copy()
        detected_objects = []

        for result in results:
            boxes = result.boxes.xyxy.cpu().numpy() if hasattr(result.boxes, 'xyxy') else []
            confidences = result.boxes.conf.cpu().numpy() if hasattr(result.boxes, 'conf') else []
            class_ids = result.boxes.cls.cpu().numpy().astype(int) if hasattr(result.boxes, 'cls') else []

            for i in range(len(boxes)):
                x1, y1, x2, y2 = map(int, boxes[i])
                w, h = x2 - x1, y2 - y1
                class_id = class_ids[i]
                class_name = self.classes[class_id]
                confidence = confidences[i]

                if class_name in COLLECTIBLES:
                    color = COLORS[f'rarity{COLLECTIBLES[class_name]["rarity"]}']
                    cv2.rectangle(result_frame, (x1, y1), (x2, y2), color, 2)
                    label = f"{class_name} {confidence:.2f}"
                    cv2.putText(result_frame, label, (x1, y1 - 10),
                                cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 2)
                    detected_objects.append({
                        'type': class_name,
                        'confidence': confidence,
                        'box': [x1, y1, w, h]
                    })

        return result_frame, detected_objects

    def collect_object(self, obj_type, confidence):
        """æ”¶é›†ç‰©ä½“"""
        current_time = datetime.now().isoformat()
        if not self.collection[obj_type]['collected']:
            self.collection[obj_type]['collected'] = True
            self.collection[obj_type]['first_collected'] = current_time
            self.collection[obj_type]['count'] = 1
            message = f"ğŸ‰ æ–°ç‰©å“æ”¶é›†: {COLLECTIBLES[obj_type]['name']}"
        else:
            self.collection[obj_type]['count'] += 1
            message = f"ğŸ“¦ å†æ¬¡æ”¶é›†: {COLLECTIBLES[obj_type]['name']} (x{self.collection[obj_type]['count']})"

        self.collection[obj_type]['last_collected'] = current_time
        self.save_collection()
        return message

    def take_picture(self):
        """æ‹ç…§å¹¶è¯†åˆ«"""
        if self.current_frame is None:
            return "âŒ æ²¡æœ‰å¯ç”¨çš„æ‘„åƒå¤´ç”»é¢"

        result_frame, detected_objects = self.detect_objects(self.current_frame.copy())

        timestamp = int(time.time())
        os.makedirs("snapshots", exist_ok=True)
        filename = f"snapshots/snapshot_{timestamp}.jpg"
        cv2.imwrite(filename, result_frame)

        messages = [f"ğŸ“¸ ç…§ç‰‡å·²ä¿å­˜: {filename}"]
        if detected_objects:
            best_obj = max(detected_objects, key=lambda x: x['confidence'])
            if best_obj['confidence'] > 0.4:
                message = self.collect_object(best_obj['type'], best_obj['confidence'])
                messages.append(message)
            else:
                messages.append("âŒ ç½®ä¿¡åº¦è¿‡ä½ï¼Œæœªæ”¶é›†")
        else:
            messages.append("âŒ æœªæ£€æµ‹åˆ°å¯æ”¶é›†ç‰©ä½“")

        return "\n".join(messages)

    def start_camera(self):
        """å¯åŠ¨æ‘„åƒå¤´çº¿ç¨‹"""
        def camera_loop():
            while self.is_running:
                ret, frame = self.cap.read()
                if ret:
                    self.current_frame = frame
                time.sleep(0.1)

        self.is_running = True
        self.camera_thread = threading.Thread(target=camera_loop)
        self.camera_thread.daemon = True
        self.camera_thread.start()

    def stop_camera(self):
        """åœæ­¢æ‘„åƒå¤´"""
        self.is_running = False
        if self.cap:
            self.cap.release()
